<!DOCTYPE html>
<html style="height:100%;">
  <body style="margin:0; background:black; height:100%;">
    <div id="player" style="width:100%; height:100%;"></div>

    <script src="https://www.youtube.com/iframe_api"></script>
    <script>
    // Variables globales con verificación de existencia
    window.player = null;
    window.playerReady = false;
    
    // Sistema de comunicación mejorado
    if (!window.unityCom) {
        window.unityCom = {
            callbacks: {},
            notify: function(msg) {
                try {
                    if (window.unityWebView && unityWebView.notify) {
                        unityWebView.notify(msg);
                    }
                } catch(e) {
                    console.error("Error en unityCom.notify:", e);
                }
            }
        };
    }

    function onYouTubeIframeAPIReady() {
        console.log("YouTube API lista - Inicializando reproductor...");
        
        try {
            player = new YT.Player('player', {
                videoId: 'dQw4w9WgXcQ',
                playerVars: {
                    'controls': 0,
                    'enablejsapi': 1,
                    'autoplay': 0,
                    'origin': window.location.origin
                },
                events: {
                    'onReady': onPlayerReady,
                    'onStateChange': onPlayerStateChange,
                    'onError': onPlayerError
                }
            });
        } catch(e) {
            console.error("Error al crear reproductor:", e);
            unityCom.notify("ERROR:" + e.message);
        }
    }

    function onPlayerReady(event) {
        console.log("Reproductor listo!");
        window.playerReady = true;
        
        // Notificar a Unity
        unityCom.notify("PLAYER_READY");
        
        // Actualizar estado inicial
        updateUnityStatus();
    }

    function onPlayerStateChange(event) {
        updateUnityStatus();
    }

    function onPlayerError(event) {
        console.error("Error en reproductor:", event.data);
        unityCom.notify("PLAYER_ERROR:" + event.data);
    }

    function updateUnityStatus() {
        try {
            var status = {
                ready: window.playerReady,
                state: player ? player.getPlayerState() : -1,
                time: player ? player.getCurrentTime() : 0,
                duration: player ? player.getDuration() : 0
            };
            
            if (window.unityCom) {
                window.unityCom.lastStatus = status;
            }
            
            // Notificar a Unity si hay cambios importantes
            if (status.state === YT.PlayerState.PLAYING) {
                unityCom.notify("PLAYING:" + status.time);
            }
        } catch(e) {
            console.error("Error en updateUnityStatus:", e);
        }
    }

    // Función para llamadas desde Unity
    function handleUnityCommand(cmd) {
        try {
            if (!player) return "PLAYER_NOT_READY";
            
            switch(cmd) {
                case 'play':
                    player.playVideo();
                    return "PLAYING";
                case 'pause':
                    player.pauseVideo();
                    return "PAUSED";
                case 'status':
                    return JSON.stringify({
                        ready: playerReady,
                        state: player.getPlayerState(),
                        time: player.getCurrentTime()
                    });
                default:
                    return "UNKNOWN_COMMAND";
            }
        } catch(e) {
            return "ERROR:" + e.message;
        }
    }
    </script>
  </body>
</html>
