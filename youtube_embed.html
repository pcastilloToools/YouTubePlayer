<!DOCTYPE html>
<html style="height:100%;">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <script>
    // Verificar si el objeto de comunicación ya existe
    if (!window._unityCom) {
        window._unityCom = {
            lastCall: 0,
            callbacks: {},
            // Función para notificar a Unity
            notify: function(event, data) {
                try {
                    var message = event + (data ? ':' + data : '');
                    // Asegúrate de que window.unityWebView y unityWebView.notify existan
                    if (window.unityWebView && unityWebView.notify) {
                        unityWebView.notify(message);
                    } else {
                        console.warn("unityWebView.notify no disponible.");
                    }
                } catch(e) {
                    console.error("Error en _unityCom.notify:", e);
                }
            },
            // Función para manejar llamadas desde Unity
            handleCommand: function(cmd) {
                try {
                    var response = "NOT_IMPLEMENTED";
                    
                    if (cmd === 'getStatus') {
                        response = JSON.stringify({
                            ready: !!window.playerReady,
                            state: window.player ? player.getPlayerState() : -1,
                            time: window.player ? player.getCurrentTime() : 0,
                            timestamp: Date.now()
                        });
                    }
                    
                    window._unityCom.lastResponse = response;
                    return response;
                } catch(e) {
                    return "ERROR:" + e.message;
                }
            }
        };
    }
    </script>
    <script src="https://www.youtube.com/iframe_api"></script> 
  </head>
  <body style="margin:0; background:black; height:100%;">
    <div id="player" style="width:100%; height:100%;"></div>

    <script>
    // Variables del reproductor
    var player = null;
    var playerReady = false;
    
    function onYouTubeIframeAPIReady() {
        console.log("YouTube API lista");
        
        try {
            player = new YT.Player('player', {
                videoId: 'dQw4w9WgXcQ', // Este es un video de ejemplo, cámbialo si necesitas
                playerVars: {
                    'playsinline': 1,
                    'enablejsapi': 1,
                    'controls': 0,
                    'autoplay': 0,
                    // 'origin' es importante para evitar errores de seguridad si lo cargas desde un servidor
                    'origin': window.location.origin 
                },
                events: {
                    'onReady': function(event) {
                        console.log("Reproductor listo");
                        playerReady = true;
                        window._unityCom.notify('PLAYER_READY');
                    },
                    'onStateChange': function(event) {
                        window._unityCom.notify('STATE_CHANGE', event.data);
                    },
                    'onError': function(event) {
                        window._unityCom.notify('PLAYER_ERROR', event.data);
                    }
                }
            });
        } catch(e) {
            console.error("Error al crear reproductor:", e);
            window._unityCom.notify('INIT_ERROR', e.message);
        }
    }
    
    // Función para Unity (ya está definida en tu HTML original)
    function updateUnityStatus() {
        if (window._unityCom && player) {
            try {
                var status = {
                    ready: playerReady,
                    state: player.getPlayerState(),
                    time: player.getCurrentTime(),
                    timestamp: Date.now()
                };
                window._unityCom.lastStatus = status;
                return JSON.stringify(status);
            } catch(e) {
                console.error("Error en updateUnityStatus:", e);
                return "ERROR:" + e.message;
            }
        }
        return "NOT_READY";
    }
    </script>
  </body>
</html>
